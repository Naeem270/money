<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shared Expense Tracker</title>
    <style>
        /* Basic Reset & Root Variables */
        :root {
            --primary-color: #007bff; /* Blue */
            --secondary-color: #6c757d; /* Gray */
            --success-color: #28a745; /* Green */
            --danger-color: #dc3545; /* Red */
            --warning-color: #ffc107; /* Yellow */
            --info-color: #17a2b8;  /* Teal for Edit */
            --light-color: #f8f9fa;
            --dark-color: #343a40;
            --background-color: #eef2f7; /* Light blue-grey background */
            --card-bg: #ffffff;
            --text-color: #333;
            --border-color: #dee2e6;
            --font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            --border-radius: 8px;
            --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html {
            font-size: 16px;
            scroll-behavior: smooth; /* Enable smooth scrolling */
        }

        body {
            font-family: var(--font-family);
            line-height: 1.6;
            color: var(--text-color);
            background-color: var(--background-color);
            padding: 1rem;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            display: grid;
            gap: 1.5rem;
        }

        header {
            text-align: center;
            margin-bottom: 1rem;
        }

        header h1 {
            color: var(--primary-color);
        }

        .card {
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            box-shadow: var(--box-shadow);
        }

        .card h2 {
            color: var(--primary-color);
            margin-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0.5rem;
            font-size: 1.3rem;
        }

        /* Form Styling */
        #expense-form {
            transition: background-color 0.3s ease;
        }
        #expense-form.editing-mode {
            /* Optional: visually indicate edit mode */
            /* background-color: #fffbf0; */
            /* border: 1px solid var(--warning-color); */
            /* padding: 1.4rem; */
            /* margin: -1.5rem; */
            border-radius: var(--border-radius);
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: bold;
            color: #555;
        }

        .form-group input[type="text"],
        .form-group input[type="number"],
        .form-group select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 1rem;
        }

        .form-group select {
            appearance: none;
            background-color: #fff;
        }

        .form-group-inline {
            display: flex;
            gap: 1rem;
            align-items: flex-end;
        }

        .amount-group {
            flex: 2;
        }
        .currency-group {
            flex: 1;
        }


        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .checkbox-group label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: normal;
            cursor: pointer;
        }
        .checkbox-group input[type="checkbox"] {
            width: auto;
            margin: 0;
            cursor: pointer;
            transform: scale(1.2);
        }


        .error-message {
            color: var(--danger-color);
            font-size: 0.9rem;
            margin-top: 0.3rem;
        }

        /* Button Styling */
        .form-actions {
            margin-top: 1.5rem;
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .btn {
            display: inline-block;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            text-align: center;
            transition: background-color 0.2s ease, opacity 0.2s ease;
            flex-grow: 1; /* Allow buttons to share space */
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }
        .btn-primary:hover {
            background-color: #0056b3;
        }

        .btn-success { /* For Update */
            background-color: var(--success-color);
            color: white;
        }
        .btn-success:hover {
            background-color: #218838;
        }

        .btn-secondary { /* For Cancel */
            background-color: var(--secondary-color);
            color: white;
        }
        .btn-secondary:hover {
            background-color: #5a6268;
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }
        .btn-danger:hover {
            background-color: #c82333;
        }

        .btn-info { /* For Edit */
             background-color: var(--info-color);
             color: white;
        }
        .btn-info:hover {
             background-color: #138496;
        }

        .btn-small {
            padding: 0.25rem 0.5rem;
            font-size: 0.8rem;
            flex-grow: 0; /* Don't let small buttons grow */
        }

        /* Hide buttons initially */
        #update-expense-btn,
        #cancel-edit-btn {
            display: none;
        }


        /* Table Styling */
        .table-container {
            overflow-x: auto;
        }

        #expenses-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        #expenses-table th,
        #expenses-table td {
            padding: 0.8rem;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            white-space: nowrap;
        }

        #expenses-table th {
            background-color: var(--light-color);
            font-weight: bold;
            color: var(--secondary-color);
            text-transform: uppercase;
            font-size: 0.9rem;
        }

        #expenses-table tbody tr:hover {
            background-color: #f1f1f1;
        }

        #expenses-table td.actions { /* Specific class for actions column */
            text-align: right; /* Align buttons to the right */
            white-space: nowrap;
        }
        #expenses-table td.actions .btn {
             margin-left: 0.3rem; /* Space between buttons */
        }


        .amount-currency {
            font-weight: bold;
        }
        .participants-list {
            font-size: 0.9em;
            color: #555;
            white-space: normal;
        }

        /* Summary Styling */
        .summary-section {
            margin-top: 1rem;
        }

        #summary-content {
            margin-bottom: 1rem;
            line-height: 1.8;
        }
        #summary-content p {
            margin-bottom: 0.5rem;
        }
        #summary-content strong {
             color: var(--dark-color);
        }
        .summary-currency-section h3 {
            margin-top: 1rem;
            margin-bottom: 0.5rem;
            color: var(--secondary-color);
            font-size: 1.1rem;
        }
        .transaction {
            padding: 0.5rem;
            background-color: var(--light-color);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            margin-bottom: 0.5rem;
        }
        .no-transactions {
            color: var(--success-color);
            font-style: italic;
        }

        #clear-data-btn-container {
            margin-top: 1rem;
            text-align: right;
        }


        /* Mobile Friendliness */
        @media (max-width: 768px) {
            .container {
                gap: 1rem;
            }
            .card {
                padding: 1rem;
            }
            .form-group-inline {
                flex-direction: column;
                align-items: stretch;
            }
            .btn {
                min-width: 100px; /* Ensure buttons have some min width */
            }
            .form-actions .btn {
                width: calc(50% - 0.25rem); /* Two buttons per row roughly */
            }
            .form-actions .btn:last-child:nth-child(odd) {
                width: 100%; /* Make last odd button full width if needed */
            }

            #clear-data-btn-container {
               text-align: center;
            }
             #clear-data-btn {
               width: 100%;
               margin-top: 1rem;
            }

            .checkbox-group {
                gap: 0.5rem 1rem;
            }

             #expenses-table th,
             #expenses-table td {
                padding: 0.6rem;
                font-size: 0.9rem;
             }
             #expenses-table td.actions {
                text-align: left; /* Stack buttons vertically on mobile */
             }
             #expenses-table td.actions .btn {
                 display: block;
                 width: 80px; /* Fixed width for action buttons */
                 margin-left: 0;
                 margin-bottom: 0.3rem;
                 text-align: center;
             }
             #expenses-table td.actions .btn:last-child {
                  margin-bottom: 0;
              }

        }
    </style>
</head>
<body>

    <div class="container">
        <header>
            <h1>Shared Expense Tracker</h1>
        </header>

        <section class="input-section card" id="input-section-card"> <!-- Added ID for scrolling -->
            <h2 id="form-title">Add New Expense</h2> <!-- Title changes in edit mode -->
            <form id="expense-form">
                <input type="hidden" id="editing-expense-id" value=""> <!-- To store ID being edited -->

                <div class="form-group">
                    <label for="payer">Who Paid?</label>
                    <select id="payer" required>
                        <!-- Options will be populated by JS -->
                    </select>
                </div>

                <div class="form-group form-group-inline">
                    <div class="amount-group">
                        <label for="amount">Amount</label>
                        <input type="number" id="amount" step="0.01" min="0.01" required placeholder="e.g., 50.00">
                    </div>
                    <div class="currency-group">
                        <label for="currency">Currency</label>
                        <select id="currency" required>
                            <option value="NIS">NIS ₪</option>
                            <option value="EUR">EUR €</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label for="description">Description</label>
                    <input type="text" id="description" required placeholder="e.g., Dinner at Luigi's">
                </div>

                <div class="form-group">
                    <label>Split Between (select all that apply):</label>
                    <div id="participants-list" class="checkbox-group">
                        <!-- Checkboxes will be populated by JS -->
                    </div>
                    <small id="participants-error" class="error-message" style="display: none;">Please select at least one participant.</small>
                </div>

                <div class="form-actions">
                     <button type="submit" id="add-expense-btn" class="btn btn-primary">Add Expense</button>
                     <button type="submit" id="update-expense-btn" class="btn btn-success">Update Expense</button> <!-- Initially hidden -->
                     <button type="button" id="cancel-edit-btn" class="btn btn-secondary">Cancel</button> <!-- Initially hidden -->
                </div>
            </form>
        </section>

        <section class="expenses-section card">
            <h2>Expenses Log</h2>
            <div class="table-container">
                <table id="expenses-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Description</th>
                            <th>Payer</th>
                            <th>Amount</th>
                            <th>Participants</th>
                            <th style="text-align:right;">Actions</th> <!-- Align header right -->
                        </tr>
                    </thead>
                    <tbody id="expenses-table-body">
                        <!-- Expense rows will be populated by JS -->
                    </tbody>
                </table>
            </div>
             <div id="no-expenses" style="display: none; text-align: center; padding: 1rem; color: #666;">No expenses logged yet.</div>
        </section>

        <section class="summary-section card">
            <h2>Summary: Who Owes Whom?</h2>
            <div id="summary-content">
                <!-- Summary will be populated by JS -->
                 <p>Calculating...</p>
            </div>
            <div id="clear-data-btn-container">
                 <button id="clear-data-btn" class="btn btn-danger">Clear All Data</button>
            </div>
        </section>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Configuration ---
            // !!! CORRECTED NAMES AND SYNTAX BELOW !!!
            const people = ["Naim", "Taysir", "Amir"]; // <-- CORRECTED NAMES AND SYNTAX
            const localStorageKey = 'sharedExpenses';

            // --- DOM Elements ---
            const payerSelect = document.getElementById('payer');
            const participantsListDiv = document.getElementById('participants-list');
            const expenseForm = document.getElementById('expense-form');
            const expensesTableBody = document.getElementById('expenses-table-body');
            const summaryContentDiv = document.getElementById('summary-content');
            const clearDataBtn = document.getElementById('clear-data-btn');
            const amountInput = document.getElementById('amount');
            const descriptionInput = document.getElementById('description');
            const currencySelect = document.getElementById('currency');
            const participantsError = document.getElementById('participants-error');
            const noExpensesDiv = document.getElementById('no-expenses');
            const addExpenseBtn = document.getElementById('add-expense-btn');
            const updateExpenseBtn = document.getElementById('update-expense-btn');
            const cancelEditBtn = document.getElementById('cancel-edit-btn');
            const editingExpenseIdInput = document.getElementById('editing-expense-id');
            const formTitle = document.getElementById('form-title');
            const inputSectionCard = document.getElementById('input-section-card');


            // --- State ---
            let expenses = [];
            // No need for editingExpenseId state variable, using hidden input instead

            // --- Functions ---

            // Load people into UI elements
            function populatePeople() {
                payerSelect.innerHTML = '';
                people.forEach(person => {
                    const option = document.createElement('option');
                    option.value = person;
                    option.textContent = person; // Use raw name for display/value
                    payerSelect.appendChild(option);
                });
                populateParticipantsCheckboxes(); // Also populate checkboxes initially
            }

            // Populate participant checkboxes (separated for reuse)
             function populateParticipantsCheckboxes() {
                 participantsListDiv.innerHTML = '';
                 people.forEach(person => {
                     const div = document.createElement('div');
                     // Generate a safe ID for the checkbox
                     const safePersonId = person.toLowerCase().replace(/[^a-z0-9_]/g, '-'); // Basic sanitization for ID
                     const checkboxId = `participant-${safePersonId}`;
                     div.innerHTML = `
                         <input type="checkbox" id="${checkboxId}" name="participants" value="${person}">
                         <label for="${checkboxId}">${escapeHtml(person)}</label> <!-- Escape name for display -->
                     `;
                     participantsListDiv.appendChild(div);
                 });
                 // Ensure checkboxes reflect 'add' mode initially
                 checkDefaultParticipants();
             }

            // Check default participants (all checked)
            function checkDefaultParticipants() {
                 participantsListDiv.querySelectorAll('input[name="participants"]').forEach(cb => cb.checked = true);
            }

            // Load expenses from localStorage
            function loadExpenses() {
                const storedExpenses = localStorage.getItem(localStorageKey);
                try {
                    expenses = storedExpenses ? JSON.parse(storedExpenses) : [];
                    if (!Array.isArray(expenses)) { // Basic check if data is corrupted
                        console.warn("Stored data is not an array, resetting.");
                        expenses = [];
                    }
                } catch (e) {
                    console.error("Error parsing stored expenses:", e);
                    expenses = []; // Reset if parsing fails
                }
                console.log("Loaded expenses:", expenses);
            }

            // Save expenses to localStorage
            function saveExpenses() {
                 try {
                    localStorage.setItem(localStorageKey, JSON.stringify(expenses));
                    console.log("Saved expenses:", expenses);
                } catch (e) {
                     console.error("Error saving expenses to localStorage:", e);
                     alert("Could not save expenses. LocalStorage might be full or disabled.");
                 }
            }

            // Set Form Mode (add or edit)
            function setFormMode(mode, expenseId = null) {
                expenseForm.reset(); // Clear form fields
                checkDefaultParticipants(); // Re-check all checkboxes for add mode
                participantsError.style.display = 'none'; // Hide error

                if (mode === 'edit') {
                    editingExpenseIdInput.value = expenseId; // Store ID in hidden input
                    addExpenseBtn.style.display = 'none';
                    updateExpenseBtn.style.display = 'inline-block';
                    cancelEditBtn.style.display = 'inline-block';
                    formTitle.textContent = 'Update Expense';
                    expenseForm.classList.add('editing-mode');
                     // Scroll form into view smoothly
                     inputSectionCard.scrollIntoView({ behavior: 'smooth', block: 'start' });

                } else { // 'add' mode
                    editingExpenseIdInput.value = ''; // Clear hidden input
                    addExpenseBtn.style.display = 'inline-block';
                    updateExpenseBtn.style.display = 'none';
                    cancelEditBtn.style.display = 'none';
                    formTitle.textContent = 'Add New Expense';
                    expenseForm.classList.remove('editing-mode');
                }
            }

            // Render the expenses table
            function renderExpensesTable() {
                expensesTableBody.innerHTML = '';

                if (!expenses || expenses.length === 0) { // Added check for null/undefined expenses
                    noExpensesDiv.style.display = 'block';
                    if (expensesTableBody.parentElement) { // Check if parent exists
                         expensesTableBody.parentElement.style.display = 'none';
                    }
                    return;
                }

                noExpensesDiv.style.display = 'none';
                 if (expensesTableBody.parentElement) {
                     expensesTableBody.parentElement.style.display = 'table';
                 }


                const sortedExpenses = [...expenses].sort((a, b) => b.timestamp - a.timestamp);

                sortedExpenses.forEach(expense => {
                    // Basic check for valid expense object structure
                    if (!expense || typeof expense.id === 'undefined') {
                        console.warn("Skipping invalid expense object:", expense);
                        return;
                    }
                    const row = document.createElement('tr');
                    const formattedDate = expense.timestamp ? new Date(expense.timestamp).toLocaleDateString() : 'N/A';
                    const formattedAmount = `<span class="amount-currency">${expense.amount ? expense.amount.toFixed(2) : '0.00'} ${expense.currency === 'NIS' ? '₪' : '€'}</span>`;
                    const participantsString = Array.isArray(expense.participants) ? expense.participants.join(', ') : '';


                    // Added actions column class and align styling in CSS
                    row.innerHTML = `
                        <td>${formattedDate}</td>
                        <td>${escapeHtml(expense.description || '')}</td>
                        <td>${escapeHtml(expense.payer || '')}</td>
                        <td>${formattedAmount}</td>
                        <td class="participants-list">${escapeHtml(participantsString)}</td>
                        <td class="actions">
                            <button class="btn btn-info btn-small edit-btn" data-id="${expense.id}">Edit</button>
                            <button class="btn btn-danger btn-small delete-btn" data-id="${expense.id}">Delete</button>
                        </td>
                    `;

                    // Add event listeners using event delegation on the table body later
                    expensesTableBody.appendChild(row);
                });
            }

             // Handle form submission (Add or Update)
            function handleFormSubmit(event) {
                event.preventDefault();

                const expenseIdToUpdate = editingExpenseIdInput.value ? parseInt(editingExpenseIdInput.value, 10) : null;

                // --- Read form data ---
                const payer = payerSelect.value;
                const amount = parseFloat(amountInput.value);
                const currency = currencySelect.value;
                const description = descriptionInput.value.trim();
                const participantCheckboxes = participantsListDiv.querySelectorAll('input[name="participants"]:checked');
                const participants = Array.from(participantCheckboxes).map(cb => cb.value);

                // --- Validation ---
                participantsError.style.display = 'none';
                if (participants.length === 0) {
                    participantsError.style.display = 'block';
                    participantsError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    return;
                }
                 if (isNaN(amount) || amount <= 0) {
                    alert("Please enter a valid positive amount.");
                    amountInput.focus();
                    return;
                 }
                 if (!description) {
                     alert("Please enter a description.");
                     descriptionInput.focus();
                     return;
                 }

                // --- Logic: Add or Update ---
                if (expenseIdToUpdate) {
                    // --- UPDATE existing expense ---
                    const expenseIndex = expenses.findIndex(exp => exp && exp.id === expenseIdToUpdate); // Check exp exists
                    if (expenseIndex > -1) {
                        expenses[expenseIndex] = {
                            ...expenses[expenseIndex], // Keep original id and timestamp
                            payer: payer,
                            amount: amount,
                            currency: currency,
                            description: description,
                            participants: participants
                        };
                        console.log("Updated expense:", expenses[expenseIndex]);
                    } else {
                         console.error("Expense ID not found for update:", expenseIdToUpdate);
                         alert("Error: Could not find the expense to update.");
                         setFormMode('add'); // Reset form if error
                         return;
                    }
                } else {
                    // --- ADD new expense ---
                    const newExpense = {
                        id: Date.now(),
                        timestamp: Date.now(),
                        payer: payer,
                        amount: amount,
                        currency: currency,
                        description: description,
                        participants: participants
                    };
                    expenses.push(newExpense);
                    console.log("Added expense:", newExpense);
                }

                saveExpenses();
                renderExpensesTable();
                renderSummary();
                setFormMode('add'); // Reset form to 'Add' mode after successful add/update

            }

             // Handle clicks on Edit or Delete buttons using Event Delegation
             function handleTableActions(event) {
                 const target = event.target; // The element that was clicked
                 const button = target.closest('button'); // Find the nearest button ancestor

                 if (!button) return; // Exit if the click wasn't on or inside a button

                 if (button.classList.contains('delete-btn')) {
                     const expenseId = parseInt(button.dataset.id, 10);
                     if (!isNaN(expenseId)) handleDeleteExpense(expenseId);
                 } else if (button.classList.contains('edit-btn')) {
                     const expenseId = parseInt(button.dataset.id, 10);
                      if (!isNaN(expenseId)) handleStartEditExpense(expenseId);
                 }
             }


            // Start editing an expense
            function handleStartEditExpense(expenseId) {
                 const expenseToEdit = expenses.find(exp => exp && exp.id === expenseId); // Check exp exists
                 if (!expenseToEdit) {
                     console.error("Expense not found for editing:", expenseId);
                     alert("Could not find the expense to edit.");
                     return;
                 }

                 // Populate form
                 payerSelect.value = expenseToEdit.payer;
                 amountInput.value = expenseToEdit.amount.toFixed(2);
                 currencySelect.value = expenseToEdit.currency;
                 descriptionInput.value = expenseToEdit.description;

                 // Set participant checkboxes
                 participantsListDiv.querySelectorAll('input[name="participants"]').forEach(cb => {
                     cb.checked = Array.isArray(expenseToEdit.participants) && expenseToEdit.participants.includes(cb.value);
                 });

                 // Switch form to edit mode
                 setFormMode('edit', expenseId);
            }

            // Handle deleting an expense
            function handleDeleteExpense(expenseId) {
                if (confirm("Are you sure you want to delete this expense?")) {
                    expenses = expenses.filter(expense => expense && expense.id !== expenseId); // Check expense exists
                    saveExpenses();
                    renderExpensesTable();
                    renderSummary();
                    // If the deleted expense was being edited, reset the form
                    if (editingExpenseIdInput.value && parseInt(editingExpenseIdInput.value, 10) === expenseId) {
                        setFormMode('add');
                    }
                    console.log("Deleted expense with ID:", expenseId);
                }
            }

             // Handle cancel edit button click
             function handleCancelEdit() {
                 setFormMode('add');
             }


            // Calculate final balances and who owes whom
            function calculateSummary() {
                const balances = {}; // { Person: { NIS: 0, EUR: 0 } }
                const currencies = ['NIS', 'EUR'];

                // Initialize balances
                people.forEach(person => {
                    balances[person] = {};
                    currencies.forEach(currency => {
                        balances[person][currency] = 0;
                    });
                });

                // Calculate net balance per person per currency
                (expenses || []).forEach(expense => { // Handle potential null/undefined expenses array
                    // Basic validation for expense object structure during calculation
                    if (!expense || typeof expense.amount !== 'number' || !Array.isArray(expense.participants)) {
                         console.warn("Skipping calculation for invalid expense object:", expense);
                         return;
                    }

                    const payer = expense.payer;
                    const amount = expense.amount;
                    const currency = expense.currency;
                    const participants = expense.participants;
                    const share = participants.length > 0 ? amount / participants.length : 0;


                    // Payer gets credited the full amount
                    if (balances[payer]) {
                        balances[payer][currency] += amount;
                    } else {
                         // If payer isn't in the 'people' array anymore, still track their balance
                         if (!balances[payer]) {
                              balances[payer] = { NIS: 0, EUR: 0 };
                         }
                         balances[payer][currency] += amount;
                         console.warn(`Payer ${payer} from expense ID ${expense.id} was not in the initial 'people' list, but added to balances.`);
                    }


                    // Each participant gets debited their share
                    participants.forEach(participant => {
                         if (balances[participant]) {
                            balances[participant][currency] -= share;
                         } else {
                              // If participant isn't in 'people' array, track their balance too
                             if (!balances[participant]) {
                                  balances[participant] = { NIS: 0, EUR: 0 };
                             }
                             balances[participant][currency] -= share;
                             console.warn(`Participant ${participant} from expense ID ${expense.id} was not in the initial 'people' list, but added to balances.`);
                         }
                    });
                });

                // --- Simplify debts for each currency ---
                const transactions = { NIS: [], EUR: [] };
                const epsilon = 0.01; // Tolerance for floating point comparisons

                const involvedPeople = Object.keys(balances); // Get all people who had any transaction

                currencies.forEach(currency => {
                    const currentBalances = involvedPeople.map(person => ({ name: person, balance: balances[person][currency] }));

                    const debtors = currentBalances.filter(p => p.balance < -epsilon).sort((a, b) => a.balance - b.balance); // Most negative first
                    const creditors = currentBalances.filter(p => p.balance > epsilon).sort((a, b) => b.balance - a.balance); // Most positive first

                    let debtorIndex = 0;
                    let creditorIndex = 0;

                    while (debtorIndex < debtors.length && creditorIndex < creditors.length) {
                        const debtor = debtors[debtorIndex];
                        const creditor = creditors[creditorIndex];
                        const amountToTransfer = Math.min(Math.abs(debtor.balance), creditor.balance);

                        if (amountToTransfer > epsilon) { // Only record meaningful transfers
                             transactions[currency].push({
                                from: debtor.name,
                                to: creditor.name,
                                amount: amountToTransfer
                            });

                            debtor.balance += amountToTransfer;
                            creditor.balance -= amountToTransfer;
                        }


                        // Move to next debtor if their balance is settled (within tolerance)
                        if (Math.abs(debtor.balance) < epsilon) {
                            debtorIndex++;
                        }
                        // Move to next creditor if their balance is settled (within tolerance)
                        if (creditor.balance < epsilon) {
                            creditorIndex++;
                        }
                    }
                });

                return transactions; // { NIS: [{from, to, amount}], EUR: [...] }
            }

            // Render the summary section
            function renderSummary() {
                summaryContentDiv.innerHTML = '<p>Calculating...</p>'; // Show calculating message
                try {
                    const summary = calculateSummary();
                    summaryContentDiv.innerHTML = ''; // Clear calculating message

                    let hasAnyTransactions = false;

                    ['NIS', 'EUR'].forEach(currency => {
                        const currencyTransactions = summary[currency];
                        const currencySymbol = currency === 'NIS' ? '₪' : '€';

                        const currencySection = document.createElement('div');
                        currencySection.classList.add('summary-currency-section');
                        currencySection.innerHTML = `<h3>${currency} Balances:</h3>`;

                        if (currencyTransactions.length === 0) {
                            currencySection.innerHTML += `<p class="no-transactions">Everyone is settled up in ${currency}.</p>`;
                        } else {
                            hasAnyTransactions = true; // Mark that we found some transactions
                            const ul = document.createElement('ul');
                            ul.style.listStyle = 'none'; // Remove default list styling
                             ul.style.paddingLeft = '0';

                            currencyTransactions.forEach(t => {
                                const li = document.createElement('li');
                                li.classList.add('transaction');
                                li.innerHTML = `
                                    <strong>${escapeHtml(t.from)}</strong> owes <strong>${escapeHtml(t.to)}</strong>
                                    <span class="amount-currency">${t.amount.toFixed(2)} ${currencySymbol}</span>
                                `;
                                ul.appendChild(li);
                            });
                             currencySection.appendChild(ul);
                        }
                        summaryContentDiv.appendChild(currencySection);
                    });

                     if (!hasAnyTransactions && expenses && expenses.length > 0) { // Check expenses array exists
                         const p = document.createElement('p');
                         p.classList.add('no-transactions');
                         p.style.marginTop = '1rem'; // Add some space
                         p.textContent = "Overall, everyone is settled up based on the logged expenses.";
                         summaryContentDiv.appendChild(p);
                     } else if (!expenses || expenses.length === 0) {
                          const p = document.createElement('p');
                          p.textContent = "Add some expenses to see the balance summary.";
                          summaryContentDiv.appendChild(p);
                     }
                 } catch (error) {
                      console.error("Error rendering summary:", error);
                      summaryContentDiv.innerHTML = '<p style="color: red;">Error calculating summary. Please check console.</p>';
                 }
            }

            // Handle clearing all data
            function handleClearData() {
                // If currently editing, maybe ask differently or cancel edit first
                if (editingExpenseIdInput.value) {
                    if (!confirm("You are currently editing an expense. Clearing all data will discard your changes. Are you sure you want to proceed?")) {
                         return;
                    }
                    setFormMode('add'); // Cancel edit before clearing
                }

                if (confirm("Are you sure you want to delete ALL expense data? This cannot be undone.")) {
                    expenses = [];
                    localStorage.removeItem(localStorageKey);
                    renderExpensesTable();
                    renderSummary();
                    setFormMode('add'); // Ensure form is in add mode
                    console.log("All data cleared.");
                }
            }

             // Utility to escape HTML to prevent XSS - CORRECTED VERSION
             function escapeHtml(unsafe) {
                 if (typeof unsafe !== 'string') {
                     console.warn("Attempted to escape non-string value:", unsafe);
                     return '';
                 }
                 // Replace special characters with their HTML entities
                 return unsafe
                      .replace(/&/g, "&") // Corrected: Use &
                      .replace(/</g, "<")
                      .replace(/>/g, ">")
                      .replace(/"/g, """) // Corrected: Use "
                      .replace(/'/g, "'"); // Corrected: Use ' or '
             }


            // --- Initialization ---
            populatePeople();
            loadExpenses();
            renderExpensesTable();
            renderSummary();
            setFormMode('add'); // Ensure initial state is 'add' mode

            // --- Event Listeners ---
            expenseForm.addEventListener('submit', handleFormSubmit);
            clearDataBtn.addEventListener('click', handleClearData);
            cancelEditBtn.addEventListener('click', handleCancelEdit);

             // Use event delegation for Edit/Delete buttons in the table body
             expensesTableBody.addEventListener('click', handleTableActions);

             // Add listener to participant checkboxes wrapper to clear error on change
             participantsListDiv.addEventListener('change', () => {
                 if(participantsError) { // Check if error element exists
                    const anyChecked = participantsListDiv.querySelector('input[name="participants"]:checked');
                    participantsError.style.display = anyChecked ? 'none' : 'block';
                 }
             });

        }); // End DOMContentLoaded
    </script>

</body>
</html>
